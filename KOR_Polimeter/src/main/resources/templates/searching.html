<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Digital Services Ranking</title>
	<link th:href="@{/css/searching_style.css}" rel="stylesheet">
	<link th:href="@{/css/default_style.css}" rel="stylesheet">
</head>
<body>
<header>
	<h1>
		<a th:href="@{/}">KOR_Polimeter</a>
	</h1>
	<nav>
		<ul>
			<li><a th:href="@{/login}">로그인</a></li>
			<li><a th:href="@{/logout}">로그아웃</a></li>
			<li><a th:href="@{/searching}">인물검색</a></li>
			<li><a th:href="@{/vote}">투표하기</a></li>
		</ul>
	</nav>
</header>

	<!-- 검색 페이지 상단 배너 -->
	<div class="TNB">
		<hr>
		<h2>인물 검색</h2>
		<hr>
	</div>
	<div class="container">
		<div class="filters">
			<!-- 필터 영역 -->
			<hr>
			<h3>필터</h3>
			<hr>
			<label><input type="radio" name="filter" value="all" checked>전체</label>
			<hr>
			<label><input type="radio" name="filter" value="2030"> 20대 ~ 30대</label>
			<label><input type="radio" name="filter" value="4050"> 40대 ~ 50대</label>
			<label><input type="radio" name="filter" value="60"> 60대~</label>
			<hr>
			<label><input type="radio" name="filter" value="men"> 남</label>
			<label><input type="radio" name="filter" value="women"> 여</label>
		</div>
		<div class="content">
			<hr>
			<!-- 검색 바 영역 -->
			<div class="search-bar">
			    <!-- 검색 조건 선택 박스 -->
			    <select id="search-type">
			        <option value="name">이름</option>
			        <option value="keyword">키워드</option>
			    </select>
			    
			    <!-- 검색 입력 -->
			    <input type="text" placeholder="검색하기" id="search">
			    
			    <!-- 검색 버튼 -->
			    <button id="search-btn">검색</button>
			    
			    <!-- Popularity 텍스트 -->
			    <span id="popularity-label">인기도</span>
			</div>
			<div>
				<hr>
				<!-- 인물 리스트 영역 -->
				<ul class="ranking-list" id="ranking-list">
				<!-- JavaScript will render ranking items here -->
				</ul>
				<div id="pagination" class="pagination"></div>
			</div>
		</div>
	</div>
	<footer>
		<p>Contact us at: sdg0896@gmail.com</p>
		<p>Website created in 2024.</p>
	</footer>

	<!-- JavaScript for dynamic content -->
	<
	<script>
		// 300개의 pol_id를 미리 생성
		const polIds = Array.from({ length: 300 }, (_, index) => index + 1); // [1, 2, 3, ..., 300]

		// rankings 배열 초기화
		const rankings = [];

		// 검색 및 필터링 데이터 저장용
		let filteredData = rankings; // 필터링된 데이터 (초기값은 전체 데이터)

		// 검색 및 필터링 적용 함수
		function applyFilters() {
			const searchInput = document.getElementById('search').value.toLowerCase(); // 검색어 입력값
			const searchType = document.getElementById('search-type').value; // 검색 타입 (이름 or 키워드)
			const selectedFilter = document.querySelector('input[name="filter"]:checked').value; // 선택된 필터 값

			// 필터링 로직
			filteredData = rankings.filter(item => {
				// 검색 조건
				const matchesSearch = searchType === 'name'
						? item.name.toLowerCase().includes(searchInput) // 이름 검색
						: item.description && item.description.toLowerCase().includes(searchInput); // 키워드 검색

				// 필터 조건
				let matchesFilter = true;
				if (selectedFilter === '2030') {
					matchesFilter = item.age >= 20 && item.age < 40;
				} else if (selectedFilter === '4050') {
					matchesFilter = item.age >= 40 && item.age < 60;
				} else if (selectedFilter === '60') {
					matchesFilter = item.age >= 60;
				} else if (selectedFilter === 'men') {
					matchesFilter = item.gender === 0; // 남성: 0
				} else if (selectedFilter === 'women') {
					matchesFilter = item.gender === 1; // 여성: 1
				}

				return matchesSearch && matchesFilter; // 검색과 필터 조건 모두 만족해야 함
			});

			currentPage = 1; // 필터 적용 시 첫 페이지로 이동
			renderPage(currentPage); // 필터링된 데이터로 페이지 렌더링
		}

		// 검색 버튼 클릭 이벤트
		document.getElementById('search-btn').addEventListener('click', applyFilters);

		// 필터 변경 이벤트
		document.querySelectorAll('input[name="filter"]').forEach(filter => {
			filter.addEventListener('change', applyFilters);
		});
		// 비동기로 데이터를 가져오고 rankings 배열에 저장
		async function fetchPoliticianData() {
			for (const polId of polIds) {
				try {
					// API 요청
					const response = await fetch('http://localhost:8080/api/politician', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({ pol_id: polId }),
					});

					// 응답 데이터 처리
					if (response.ok) {
						const item = await response.json();

						// rankings 배열에 데이터 추가
						rankings.push({
							id: item.id,
							name: item.name,
							party: item.party,
							region: item.region,
							bday: item.bday,
							age: item.age,
							description: item.description,
							gender: item.gender,
							popularity: `${Math.floor(Math.random() * 100)}%`, // 인기도는 랜덤 값으로 설정
							image: `images/politicians/${item.party}/${item.name}.jpg`, // 템플릿 리터럴 수정
						});
					} else {
						console.error(`Failed to fetch data for pol_id: ${polId}`);
					}
				} catch (error) {
					console.error(`Error fetching data for pol_id: ${polId}`, error);
				}
			}

			// 데이터 로드 완료 후 첫 페이지 렌더링
			renderPage(currentPage);
		}

		// 한 페이지에 표시할 항목 수
		const itemsPerPage = 5;
		let currentPage = 1;

		// 현재 페이지 데이터를 렌더링하는 함수
		function renderPage(page) {
			const rankingList = document.getElementById('ranking-list');
			const startIndex = (page - 1) * itemsPerPage;
			const endIndex = startIndex + itemsPerPage;
			const pageItems = filteredData.slice(startIndex, endIndex); // 필터링된 데이터 사용

			// 현재 페이지의 랭킹 항목 렌더링
			rankingList.innerHTML = pageItems.map(item => `
        <li class="ranking-item" data-id="${item.id}">
            <span class="ranking-number">${item.id}</span>
            <img src="${item.image}" alt="${item.name}">
            <div class="ranking-details">
                <span class="name">${item.name}</span>
                <span class="popularity">${item.popularity}</span>
            </div>
        </li>
    `).join('');

			// 페이지네이션 렌더링
			renderPagination();

			// 항목 클릭 시 상세 페이지로 이동
			const rankingItems = document.querySelectorAll('.ranking-item');
			rankingItems.forEach((item, index) => {
				item.addEventListener('click', () => {
					const clickedItem = pageItems[index]; // 현재 페이지의 데이터에서 클릭된 항목 가져오기
					window.location.href = `/details?id=${clickedItem.id}&name=${encodeURIComponent(clickedItem.name)}&party=${encodeURIComponent(clickedItem.party)}&region=${encodeURIComponent(clickedItem.region)}&bday=${encodeURIComponent(clickedItem.bday)}&age=${encodeURIComponent(clickedItem.age)}&description=${encodeURIComponent(clickedItem.description)}&gender=${encodeURIComponent(clickedItem.gender)}`;
				});
			});
		}

		// 페이지네이션 버튼 렌더링 함수
		function renderPagination() {
			const pagination = document.getElementById('pagination');
			const totalPages = Math.ceil(filteredData.length / itemsPerPage); // 필터링된 데이터 기준으로 총 페이지 수 계산

			pagination.innerHTML = ''; // 기존 버튼 초기화

			// '맨 처음으로 가는 버튼' 추가
			const firstButton = document.createElement('button');
			firstButton.textContent = '<<';
			firstButton.classList.add('page-btn');
			firstButton.disabled = currentPage === 1; // 첫 페이지에서는 비활성화
			firstButton.addEventListener('click', () => {
				currentPage = 1;
				renderPage(currentPage);
			});
			pagination.appendChild(firstButton);

			// 이전 페이지 버튼
			const prevButton = document.createElement('button');
			prevButton.textContent = '<';
			prevButton.classList.add('page-btn');
			prevButton.disabled = currentPage === 1; // 첫 페이지에서는 비활성화
			prevButton.addEventListener('click', () => {
				if (currentPage > 1) {
					currentPage--;
					renderPage(currentPage);
				}
			});
			pagination.appendChild(prevButton);

			// 페이지 버튼 표시 범위 계산
			const maxVisibleButtons = 5; // 한 번에 표시할 페이지 버튼 수

			let startPage, endPage;

			if (currentPage <= Math.ceil(maxVisibleButtons / 2)) {
				// 현재 페이지가 첫 그룹(1~5)에 있을 경우
				startPage = 1;
				endPage = Math.min(totalPages, maxVisibleButtons);
			} else if (currentPage > totalPages - Math.floor(maxVisibleButtons / 2)) {
				// 현재 페이지가 마지막 그룹에 가까울 경우
				startPage = Math.max(1, totalPages - maxVisibleButtons + 1);
				endPage = totalPages;
			} else {
				// 현재 페이지가 중간 그룹에 있을 경우
				startPage = currentPage - Math.floor(maxVisibleButtons / 2);
				endPage = currentPage + Math.floor(maxVisibleButtons / 2);
			}

			// "1 ..." 표시 (현재 페이지가 첫 그룹을 벗어났을 때)
			if (startPage > 1) {
				const firstPageButton = document.createElement('button');
				firstPageButton.textContent = '1';
				firstPageButton.classList.add('page-btn');
				firstPageButton.addEventListener('click', () => {
					currentPage = 1;
					renderPage(currentPage);
				});
				pagination.appendChild(firstPageButton);

				if (startPage > 2) { // 1 바로 뒤에 "..." 표시
					const dots = document.createElement('span');
					dots.textContent = '...';
					dots.classList.add('dots');
					pagination.appendChild(dots);
				}
			}

			// 현재 그룹의 페이지 버튼 생성
			for (let i = startPage; i <= endPage; i++) {
				const button = document.createElement('button');
				button.textContent = i;
				button.classList.add('page-btn');
				if (i === currentPage) {
					button.classList.add('active'); // 현재 페이지 표시
				}
				button.addEventListener('click', () => {
					currentPage = i;
					renderPage(currentPage);
				});
				pagination.appendChild(button);
			}

			// "... 마지막 페이지" 표시 (현재 페이지가 마지막 그룹 이전일 때)
			if (endPage < totalPages) {
				if (endPage < totalPages - 1) { // 마지막 페이지 바로 앞에 "..." 표시
					const dots = document.createElement('span');
					dots.textContent = '...';
					dots.classList.add('dots');
					pagination.appendChild(dots);
				}

				const lastPageButton = document.createElement('button');
				lastPageButton.textContent = totalPages;
				lastPageButton.classList.add('page-btn');
				lastPageButton.addEventListener('click', () => {
					currentPage = totalPages;
					renderPage(currentPage);
				});
				pagination.appendChild(lastPageButton);
			}

			// 다음 페이지 버튼
			const nextButton = document.createElement('button');
			nextButton.textContent = '>';
			nextButton.classList.add('page-btn');
			nextButton.disabled = currentPage === totalPages; // 마지막 페이지에서는 비활성화
			nextButton.addEventListener('click', () => {
				if (currentPage < totalPages) {
					currentPage++;
					renderPage(currentPage);
				}
			});
			pagination.appendChild(nextButton);

			// '맨 뒤로 가는 버튼' 추가
			const lastButton = document.createElement('button');
			lastButton.textContent = '>>';
			lastButton.classList.add('page-btn');
			lastButton.disabled = currentPage === totalPages; // 마지막 페이지에서는 비활성화
			lastButton.addEventListener('click', () => {
				currentPage = totalPages;
				renderPage(currentPage);
			});
			pagination.appendChild(lastButton);
		}

		// 초기 데이터 로드 및 렌더링
		document.addEventListener('DOMContentLoaded', async () => {
			await fetchPoliticianData(); // 데이터 로드
		});

		document.addEventListener('DOMContentLoaded', () => {
			const rankingList = document.getElementById('ranking-list');

			// 상위 20개 항목만 표시
			const top20 = rankings.slice(0, 5);

			rankingList.innerHTML = top20.map(item => `
				<li class="ranking-item" data-id="${item.id}">
					<span class="ranking-number">${item.id}</span>
					<img src="${item.image}" alt="${item.name}">
					<div class="ranking-details">
						<span class="name">${item.name}</span>
						<span class="popularity">${item.popularity}</span>
					</div>
				</li>
			`).join('');

			// 항목 클릭 시 상세 페이지로 이동
			const rankingItems = document.querySelectorAll('.ranking-item');
			rankingItems.forEach(item => {
				item.addEventListener('click', () => {
					window.location.href = `/details?id=${item.id}&name=${item.name}&party=${item.party}&region=${item.region}&bday=${item.bday}&age=${item.age}&description=${item.description}&gender=${item.gender}`;
				});
			});
		});
	</script>
</body>
</html>